<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telemetry Dashboard - Agentic AI News</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Monaco', 'Courier New', monospace; 
            background: #0a0a0a; 
            color: #00ff00;
            padding: 20px;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff00;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff00;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
        }
        .panel h2 {
            color: #00ff00;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .metric:last-child {
            border-bottom: none;
        }
        .metric-label {
            color: #888;
        }
        .metric-value {
            color: #00ff00;
            font-weight: bold;
        }
        .status-ok { color: #00ff00; }
        .status-warning { color: #ffaa00; }
        .status-error { color: #ff0044; }
        .logs-container {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-entry {
            padding: 4px;
            margin: 2px 0;
            border-left: 3px solid transparent;
        }
        .log-debug { border-left-color: #666; color: #666; }
        .log-info { border-left-color: #00ff00; color: #00ff00; }
        .log-warn { border-left-color: #ffaa00; color: #ffaa00; }
        .log-error { border-left-color: #ff0044; color: #ff0044; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            border-radius: 4px;
        }
        button:hover {
            background: #00dd00;
            box-shadow: 0 0 10px #00ff00;
        }
        .error-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .error-item {
            background: #2a0a0a;
            border: 1px solid #ff0044;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        pre {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .refresh-timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            padding: 10px;
            border: 1px solid #00ff00;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>üéÆ Telemetry Dashboard</h1>
        
        <div class="refresh-timer">
            Auto-refresh: <span id="refresh-countdown">5</span>s
            <button onclick="toggleAutoRefresh()">Toggle</button>
        </div>

        <div class="grid">
            <!-- Health Status -->
            <div class="panel">
                <h2>üè• Health Status</h2>
                <div id="health-status">Loading...</div>
            </div>

            <!-- Metrics Overview -->
            <div class="panel">
                <h2>üìä Metrics Overview</h2>
                <div id="metrics-overview">Loading...</div>
            </div>

            <!-- Error Tracking -->
            <div class="panel">
                <h2>üî• Error Tracking</h2>
                <div id="error-tracking">Loading...</div>
            </div>

            <!-- Debug Info -->
            <div class="panel">
                <h2>üêõ Debug Info</h2>
                <div id="debug-info">Loading...</div>
            </div>
        </div>

        <!-- Real-time Logs -->
        <div class="panel">
            <h2>üìú Real-time Logs (WebSocket)</h2>
            <div class="logs-container" id="logs-container">
                <div class="log-entry log-info">Waiting for logs...</div>
            </div>
        </div>

        <!-- Raw Metrics -->
        <div class="panel">
            <h2>üìà Prometheus Metrics</h2>
            <button onclick="fetchMetrics()">Refresh Metrics</button>
            <button onclick="downloadMetrics()">Download</button>
            <pre id="raw-metrics">Loading...</pre>
        </div>

        <!-- Test Controls -->
        <div class="panel">
            <h2>üß™ Test Telemetry</h2>
            <button onclick="testEndpoint('/')">Test Homepage</button>
            <button onclick="testEndpoint('/news', 'POST')">Test Create News</button>
            <button onclick="testEndpoint('/vote', 'POST')">Test Vote</button>
            <button onclick="triggerError()">Trigger Error</button>
            <button onclick="testSlowRequest()">Test Slow Request</button>
            <button onclick="testRateLimit()">Test Rate Limit</button>
        </div>
    </div>

    <script>
        let autoRefresh = true;
        let refreshInterval;
        let wsConnection;

        async function fetchHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                document.getElementById('health-status').innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Status:</span>
                        <span class="metric-value status-ok">${data.status}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Uptime:</span>
                        <span class="metric-value">${Math.floor(data.uptime / 60)}m ${Math.floor(data.uptime % 60)}s</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Memory (RSS):</span>
                        <span class="metric-value">${(data.memory.rss / 1024 / 1024).toFixed(2)} MB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Heap Used:</span>
                        <span class="metric-value">${(data.memory.heapUsed / 1024 / 1024).toFixed(2)} MB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Version:</span>
                        <span class="metric-value">${data.version}</span>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to fetch health:', error);
            }
        }

        async function fetchErrors() {
            try {
                const response = await fetch('/errors');
                const data = await response.json();
                
                let errorHtml = `
                    <div class="metric">
                        <span class="metric-label">Total Errors:</span>
                        <span class="metric-value ${data.total > 0 ? 'status-error' : 'status-ok'}">${data.total}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Unresolved:</span>
                        <span class="metric-value ${data.unresolved > 0 ? 'status-warning' : 'status-ok'}">${data.unresolved}</span>
                    </div>
                `;
                
                if (data.bySeverity) {
                    Object.entries(data.bySeverity).forEach(([severity, count]) => {
                        errorHtml += `
                            <div class="metric">
                                <span class="metric-label">${severity}:</span>
                                <span class="metric-value">${count}</span>
                            </div>
                        `;
                    });
                }
                
                if (data.mostFrequent && data.mostFrequent.length > 0) {
                    errorHtml += '<div class="error-list">';
                    data.mostFrequent.slice(0, 3).forEach(error => {
                        errorHtml += `
                            <div class="error-item">
                                <strong>${error.name}</strong>: ${error.message}<br>
                                <small>Count: ${error.occurrences} | Last: ${new Date(error.lastSeen).toLocaleTimeString()}</small>
                            </div>
                        `;
                    });
                    errorHtml += '</div>';
                }
                
                document.getElementById('error-tracking').innerHTML = errorHtml;
            } catch (error) {
                console.error('Failed to fetch errors:', error);
            }
        }

        async function fetchDebugInfo() {
            try {
                const response = await fetch('/debug');
                const data = await response.json();
                
                let debugHtml = `
                    <div class="metric">
                        <span class="metric-label">Active Sessions:</span>
                        <span class="metric-value">${data.sessions ? data.sessions.length : 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Breakpoints:</span>
                        <span class="metric-value">${data.breakpoints ? data.breakpoints.length : 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">CPU User:</span>
                        <span class="metric-value">${(data.metrics.cpu.user / 1000).toFixed(2)}s</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">CPU System:</span>
                        <span class="metric-value">${(data.metrics.cpu.system / 1000).toFixed(2)}s</span>
                    </div>
                `;
                
                document.getElementById('debug-info').innerHTML = debugHtml;
            } catch (error) {
                console.error('Failed to fetch debug info:', error);
            }
        }

        async function fetchMetrics() {
            try {
                const response = await fetch('/metrics');
                const text = await response.text();
                
                // Parse some key metrics for overview
                const lines = text.split('\n');
                let requestTotal = 0;
                let errorTotal = 0;
                let newsTotal = 0;
                let votesTotal = 0;
                
                lines.forEach(line => {
                    if (line.startsWith('http_requests_total')) {
                        const match = line.match(/} (\d+)/);
                        if (match) requestTotal += parseInt(match[1]);
                    }
                    if (line.startsWith('http_request_errors_total')) {
                        const match = line.match(/} (\d+)/);
                        if (match) errorTotal += parseInt(match[1]);
                    }
                    if (line.startsWith('news_items_total')) {
                        const match = line.match(/} (\d+)/);
                        if (match) newsTotal += parseInt(match[1]);
                    }
                    if (line.startsWith('votes_total')) {
                        const match = line.match(/} (\d+)/);
                        if (match) votesTotal += parseInt(match[1]);
                    }
                });
                
                document.getElementById('metrics-overview').innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Total Requests:</span>
                        <span class="metric-value">${requestTotal}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Request Errors:</span>
                        <span class="metric-value ${errorTotal > 0 ? 'status-error' : 'status-ok'}">${errorTotal}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">News Posted:</span>
                        <span class="metric-value">${newsTotal}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Votes Cast:</span>
                        <span class="metric-value">${votesTotal}</span>
                    </div>
                `;
                
                document.getElementById('raw-metrics').textContent = text.substring(0, 2000) + '...';
            } catch (error) {
                console.error('Failed to fetch metrics:', error);
            }
        }

        function downloadMetrics() {
            fetch('/metrics')
                .then(response => response.text())
                .then(text => {
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `metrics_${new Date().toISOString()}.txt`;
                    a.click();
                });
        }

        async function testEndpoint(path, method = 'GET') {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };
            
            if (method === 'POST' && path === '/news') {
                options.body = JSON.stringify({
                    summary: 'Test news item from telemetry dashboard',
                    link: 'https://example.com/test',
                    author: 'Telemetry Test'
                });
            } else if (method === 'POST' && path === '/vote') {
                options.body = JSON.stringify({
                    newsId: 1,
                    voteType: 'up',
                    source: 'machine'
                });
            }
            
            try {
                const response = await fetch(path, options);
                const data = await response.json();
                console.log('Test response:', data);
                alert(`Test ${method} ${path}: ${response.status} ${response.statusText}`);
            } catch (error) {
                console.error('Test failed:', error);
                alert(`Test failed: ${error.message}`);
            }
        }

        async function triggerError() {
            try {
                await fetch('/trigger-error');
            } catch (error) {
                console.log('Error triggered successfully');
            }
            setTimeout(fetchErrors, 1000);
        }

        async function testSlowRequest() {
            alert('Sending slow request - check logs for performance warning');
            await fetch('/test-slow');
        }

        async function testRateLimit() {
            alert('Sending 20 rapid requests to test rate limiting');
            for (let i = 0; i < 20; i++) {
                fetch('/').catch(() => {});
            }
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            if (autoRefresh) {
                startAutoRefresh();
            } else {
                clearInterval(refreshInterval);
                document.getElementById('refresh-countdown').textContent = 'OFF';
            }
        }

        function startAutoRefresh() {
            let countdown = 5;
            refreshInterval = setInterval(() => {
                countdown--;
                if (countdown <= 0) {
                    countdown = 5;
                    refreshAll();
                }
                document.getElementById('refresh-countdown').textContent = autoRefresh ? countdown : 'OFF';
            }, 1000);
        }

        function refreshAll() {
            fetchHealth();
            fetchMetrics();
            fetchErrors();
            fetchDebugInfo();
        }

        function connectWebSocket() {
            // This would connect to a WebSocket for real-time logs
            // For now, we'll simulate with polling
            setInterval(() => {
                const logTypes = ['info', 'debug', 'warn', 'error'];
                const logMessages = [
                    'Request received: GET /',
                    'Database query executed in 2ms',
                    'Vote recorded successfully',
                    'Cache hit for news items',
                    'Slow query detected: 1200ms'
                ];
                
                const type = logTypes[Math.floor(Math.random() * logTypes.length)];
                const message = logMessages[Math.floor(Math.random() * logMessages.length)];
                
                const container = document.getElementById('logs-container');
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] [${type.toUpperCase()}] ${message}`;
                container.appendChild(entry);
                
                // Keep only last 50 logs
                while (container.children.length > 50) {
                    container.removeChild(container.firstChild);
                }
                
                container.scrollTop = container.scrollHeight;
            }, 2000);
        }

        // Initialize
        refreshAll();
        startAutoRefresh();
        connectWebSocket();
    </script>
</body>
</html>